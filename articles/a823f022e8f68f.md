---
title: "Rustã§utoipaã‚’ä½¿ã£ã¦OpenAPIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å…¬é–‹ã™ã‚‹"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

ä»Šå›ã¯utoipaã‚’ä½¿ã£ã¦ã€Rustã§å®Ÿè£…ã—ãŸAPIã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

# TL;DR

1. [utoipa](https://github.com/juhaku/utoipa)ã‚’cloneã™ã‚‹ã€‚
1. examplesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚‹å¥½ããªç’°å¢ƒã§ã€`cargo run`å®Ÿè¡Œã™ã‚‹ã€‚
1. `http://localhost:8080/swagger-ui`ã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚
1. Swagger UIã§APIãŒç¢ºèªã§ãã‚‹ã€‚

# ã¯ã˜ã‚ã«

Rustã§å®Ÿè£…ã—ãŸãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ã€
Rustã ã‘ã§ã©ã†ã«ã‹ãªã‚‰ãªã„ã‹ãªã¨æ¤œç´¢ã—ãŸã‚‰ã€utoipaã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§è§£æ±ºã§ããã†ã ã£ãŸã®ã§ã€ çµ„ã¿è¾¼ã‚“ã§Swagger UIã§ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚
ãŒã‚“ã°ã‚Œã°OpenAPI
GeneratorãŒç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã§ã™ï¼ˆ[å‚è€ƒè¨˜äº‹](https://qiita.com/takahashik0422/items/be5a88af33716ea15c01)ï¼‰

### utoipaã¨ã¯

<https://github.com/juhaku/utoipa>

> Want to have your API documented with OpenAPI? But you dont want to see the
> trouble with manual yaml or json tweaking? Would like it to be so easy that it
> would almost be like utopic? Don't worry utoipa is just there to fill this
> gap. It aims to do if not all then the most of heavy lifting for you enabling
> you to focus writing the actual API logic instead of documentation. It aims to
> be minimal, simple and fast. It uses simple proc macros which you can use to
> annotate your code to have items documented.

utoipaã®READMEã‚ˆã‚Šå¼•ç”¨

è¦ç´„ã™ã‚‹ã¨Rustã ã‘ã§ã€ã‚ˆã„æ„Ÿã˜ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œã‚Œã‚‹ã‚ˆã¨ã„ã†æ„Ÿã˜ã§ã™ã€‚
ä»Šå›ã¯actix-webã‚’ä½¿ã„ã¾ã™ãŒã€ä»–ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼ˆaxumã€warpã€tideã€rocketï¼‰ã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

### ã‚´ãƒ¼ãƒ«

ä»Šå›ã¯actix-webã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å®Ÿè£…ã—ã€utoipaã‚’ä½¿ã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ–ãƒ©ã‚¦ã‚¶ã§APIã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-12-07 17.58.12.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/20556/5149b3ed-99b7-39d5-69e1-c3420c87b3c0.png)

# ç’°å¢ƒ

ä»Šå›ä½¿ç”¨ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã¯[ã“ã¡ã‚‰](https://github.com/w40141/utoipa_sample)ã«ã‚ã‚Šã¾ã™ã€‚

### åˆ©ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- å¿…é ˆ
  - [utoipa](https://github.com/juhaku/utoipa)
  - [utoipa-swagger-ui](https://github.com/juhaku/utoipa)
  - [actix-web](https://github.com/actix/actix-web)
- ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼ˆä»Šå›ã®å®Ÿè£…ã§ä½¿ã£ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
  - [uild](https://github.com/dylanhart/ulid-rs)
  - [chrono](https://github.com/chronotope/chrono)
  - [anyhow](https://github.com/dtolnay/anyhow)
  - [serde](https://github.com/serde-rs/serde)

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ‘ã‚¹ãªã©ã¯apiãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ï¼ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¯ã‚‚ã£ã¨å·¥å¤«ã§ãã‚‹ã¨æ€ã„ã¾ã™ï¼‰ã€‚
ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

```shell
./src
â”œâ”€â”€ api
â”‚Â Â  â”œâ”€â”€ composition.rs // ä¾å­˜æ€§æ³¨å…¥
â”‚Â Â  â”œâ”€â”€ execute.rs // usecaseå±¤ã‚’ä½¿ãŸå®Ÿè£…
â”‚Â Â  â”œâ”€â”€ request.rs // ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ã®ãƒ¢ãƒ‡ãƒ«
â”‚Â Â  â”œâ”€â”€ response.rs // ãƒ¬ã‚¹ãƒã‚¤ãƒ³ã‚¹ç”¨ã®ãƒ¢ãƒ‡ãƒ«
â”‚Â Â  â”œâ”€â”€ route  // executeã¨compositionã‚’ä½¿ã£ãŸAPIï¼ˆãƒ‘ã‚¹ï¼‰ã®å®Ÿè£…
â”‚Â Â  â””â”€â”€ route.rs // OpanAPIã®è¨­å®šã¨actix-webã®è¨­å®š
â”œâ”€â”€ api.rs
â”œâ”€â”€ domaim  // ãƒ‰ãƒ¡ã‚¤ãƒ³ã®å®Ÿè£…
â”œâ”€â”€ domain.rs
â”œâ”€â”€ infra  // DBãƒ¢ãƒƒã‚¯ã®å®Ÿè£…
â”œâ”€â”€ infra.rs
â”œâ”€â”€ main.rs  // ã‚µãƒ¼ãƒãƒ¼ã®å®Ÿè£…
â”œâ”€â”€ usecase  // å„ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã®å®Ÿè£…
â””â”€â”€ usecase.rs
```

# ä½¿ã„æ–¹

utoipaã‚’ä½¿ã†ãŸã‚ã«ã¯ToSchemaã€IntoParamsã€Pathã€OpanAPIã¨ã„ã†Deriveã‚’Structã‹é–¢æ•°ã«è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã“ã‚Œã ã‘ã§ã‚ˆã„ï¼ï¼‰ã€‚

### ToSchema

ToSchemaã¯requestã‚„responseã®Structã«å¯¾ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚ï¼ˆ[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.rs/utoipa/latest/utoipa/derive.ToSchema.html)ï¼‰

```rust: api/request.rs
use utoipa::ToSchema;

#[derive(Deserialize, ToSchema)]
pub struct RegisterUserRequest {
    name: String,
    email: String,
}
```

### IntoParams

IntoParamsã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’Structã¨ã™ã‚‹å ´åˆã«è¿½åŠ ã—ã¾ã™ã€‚ï¼ˆ[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.rs/utoipa/latest/utoipa/derive.IntoParams.html)ï¼‰
`example/{name}`ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’Nameã¨ã„ã†Structã§å®šç¾©ã—ãŸå ´åˆã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚

```rust: api/request.rs
use utoipa::IntoParams;

#[derive(Deserialize, IntoParams)]
pub struct Name {
    /// User name
    name: String,
}
```

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¬æ˜ãŒæ›¸ã‘ã¾ã™ã€‚

### Path

ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦æŒ‡å®šã—ãŸé–¢æ•°ã«è¿½åŠ ã—ã¾ã™ã€‚ï¼ˆ[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.rs/utoipa/latest/utoipa/attr.path.html)ï¼‰

```rust: api/route/register_user.rs
use actix_web::error::ErrorInternalServerError;
use actix_web::error::ErrorNotFound;
use actix_web::{get, post, web, Responder, Result};

#[utoipa::path(
    post,
    request_body = RegisterUserRequest,
    responses(
        (status = 200, description = "Register User", body = RegisterUserRequest),
        (status = 500, description = "Internal error")
    ),
)]
#[post("/register")]
pub async fn register_user(req: web::Json<RegisterUserRequest>) -> Result<impl Responder> {
    let name = req.0.name();
    let email = req.0.email();
    let Ok(user) = Composition::register_user().run(name, email).await
        else {return Err(ErrorInternalServerError("InternalError"))};
    Ok(web::Json(RegisterUserResponse::from(user)))
}

#[utoipa::path(
    get,
    context_path = "/user",
    params(Name),
    responses(
        (status = 200, description = "Search User", body = SearchedUserResponse),
        (status = 404, description = "Not found")
    ),
)]
#[get("/{name}")]
pub async fn search_user(req: web::Path<Name>) -> Result<impl Responder> {
    let name = req.name();
    let Ok(user) = Composition::search_user().run(name).await
        else { return Err(ErrorNotFound("NotFound"))};
    Ok(web::Json(SearchedUserResponse::from(user)))
}
```

pathã«ã¯ä»¥ä¸‹ã‚’è¨­å®šã§ãã¾ã™ã€‚

- operation
  - ä¾‹ï¼šget, post, put, delete, head, options, connect, path, trace
- path
  - è¨˜è¿°ã—ãªã„ã¨actix-webã§è¨­å®šã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãªã‚‹ã‚ˆã†ã§ã™
- operation_id
  - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é–¢æ•°åã«ãªã‚‹ã‚ˆã†ã§ã™
- context_path
  - ã‚¹ã‚³ãƒ¼ãƒ—ãŒæŒ‡å®šã—ã¦ã‚ã‚‹å ´åˆã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å‰ã«è¡¨ç¤ºã§ãã¾ã™
- tag
- request_body
  - å®šç¾©ã—ãŸstructã‚’æŒ‡å®šã§ãã¾ã™
- response
  - è¤‡æ•°ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæŒ‡å®šã§ãã¾ã™
- params
  - IntoParamsã‚’è¿½åŠ ã—ãŸStructã‚’æŒ‡å®šã§ãã¾ã™
- security

### OpenAPI

OpenApiã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã—ãŸã„ã‚‚ã®ã‚’ã¾ã¨ã‚ã¾ã™ã€‚ï¼ˆ[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.rs/utoipa/latest/utoipa/derive.OpenApi.html)ï¼‰

```rust: api/route.rs
#[derive(OpenApi)]
#[openapi(
    paths(
        route::check_health::check_health,
        route::register_user::register_user,
        route::post_tweet::post_tweet,
        route::user::search_user::search_user,
        route::tweets::get_all_tweets::get_all_tweets,
    ),
    components(schemas(
        RegisterUserRequest,
        PostTweetRequest,
        RegisterUserResponse,
        PostTweetResponse,
        SearchedUserResponse,
        GetAllTweetResponse
    ))
)]
struct ApiDoc;
```

openapiã«ã¯ä»¥ä¸‹ãŒæŒ‡å®šã§ãã¾ã™ã€‚

- paths
  - `#[utoipa::path]`ã‚’è¿½åŠ ã—ãŸé–¢æ•°ã‚’è¿½åŠ ã—ã¾ã™
- components(schema, response)
  - schemas
    - `ToSchema`Deriveã‚’è¿½åŠ ã—ãŸStructã‚’è¿½åŠ ã—ã¾ã™
  - response
    - `ToResponse`Traitã‚’å®Ÿè£…ã—ãŸStructã‚’è¿½åŠ ã—ã¾ã™
- modifiers
- security
- tags
- external_docs

# actix-webã¸ã®çµ„ã¿è¾¼ã¿

`main.rs`ã«é€šå¸¸ã®serviceç™»éŒ²ã¨åˆ¥ã«swagger-uiã‚’è¦‹ã‚‹ãŸã‚ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚

```rust: api/route.rs
use actix_web::{App, HttpServer};

pub fn config(cfg: &mut web::ServiceConfig) {
    cfg.service(check_health::check_health)
        .service(register_user::register_user)
        .service(post_tweet::post_tweet)
        .configure(user::config)
        .configure(tweets::config)
        .service(
            SwaggerUi::new("/swagger-ui/{_:.*}")
                .url("/api-doc/opanapi.json", ApiDoc::openapi()),
        );
}
```

```rust: main.rs
#[actix_web::main]
async fn main() -> std::io::Result<()> {
    HttpServer::new(|| App::new().configure(config))
        .bind(("127.0.0.1", 8080))?
        .run()
        .await
}
```

`cargo run`ã§ã‚µãƒ¼ãƒã‚’èµ·å‹•ã™ã‚‹ã“ã¨ã§ã€`http://localhost:8080/swagger-ui/`ã¸ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä¸Šè¨˜ã®ã‚ˆã†ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚

# ãŠã‚ã‚Šã«

ç‰¹æ®µé›£ã—ã„ã“ã¨ã¯ã›ãšã«Rustã®ã‚³ãƒ¼ãƒ‰ã ã‘ã§APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå…¬é–‹ã§ãã¾ã™ã€‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã‚’å·¥å¤«ã™ã‚‹ã“ã¨ã§OpenAPIã£ã½ããªã‚‹ã¨æ€ã„ã¾ã™ã€‚
ã“ã“ã§ã¯ç´¹ä»‹ã—ã¦ã„ãªã„æ©Ÿèƒ½ã‚‚ã‚ã‚‹ã®ã§ã€ã‚‚ã£ã¨æ´»ç”¨ã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚
